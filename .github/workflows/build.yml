name: Windows Build

on: [push, pull_request, workflow_dispatch]

jobs:
  build:
    runs-on: windows-2019

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    - name: Patch Projects (Framework & SDK)
      run: |
        # Versuche die installierte SDK Version zu finden
        $sdk = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Microsoft SDKs\Windows\v10.0" -Name "ProductVersion" -ErrorAction SilentlyContinue).ProductVersion
        if (!$sdk) { $sdk = "10.0.17763.0" } 
        echo "Using Windows SDK: $sdk"

        $projects = Get-ChildItem -Recurse -Include *.csproj, *.vcxproj
        foreach ($proj in $projects) {
          $content = Get-Content $proj.FullName -Raw
          $content = $content -replace '<TargetFrameworkVersion>v4\.0.*</TargetFrameworkVersion>', '<TargetFrameworkVersion>v4.8</TargetFrameworkVersion>'
          $content = $content -replace '<TargetFrameworkVersion>v4\.6\.1</TargetFrameworkVersion>', '<TargetFrameworkVersion>v4.8</TargetFrameworkVersion>'
          $content = $content -replace '<TargetFrameworkProfile>Client</TargetFrameworkProfile>', ''
          $content = $content -replace '<WindowsTargetPlatformVersion>.*</WindowsTargetPlatformVersion>', "<WindowsTargetPlatformVersion>$sdk</WindowsTargetPlatformVersion>"
          Set-Content $proj.FullName $content -NoNewline
        }
      shell: powershell

    - name: Restore NuGet Packages
      run: nuget restore wfSpy.sln

    - name: Build Solution (Ignore Errors)
      # /p:ContinueOnError=WarnAndContinue l√§sst MSBuild weitermachen, wenn ein Projekt (wie C++) scheitert
      run: msbuild wfSpy.sln /p:Configuration=Release /p:Platform="x86" /p:ContinueOnError=WarnAndContinue

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wfSpy-Build-Results
        # Wir sammeln alles ein, was gebaut werden konnte
        path: |
          **/bin/x86/Release/
          **/bin/Release/
          **/*.exe
          **/*.dll